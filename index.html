<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Bierzelt Rechner</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
      max-width: 600px;
      margin: auto;
      font-size: 1.1rem;
    }
    h1, h2 {
      text-align: center;
    }
    .item, .drink-row {
      display: flex;
      align-items: center;
      margin: 0.6rem 0;
      gap: 0.5rem;
    }
    .item .name, .drink-row .label {
      flex: 1;
    }
    button {
      padding: 0.6rem 1.2rem;
      font-size: 1.1rem;
      border: none;
      border-radius: 6px;
      background: #e0e0e0;
    }
    button:active {
      background: #bdbdbd;
    }
    .count {
      width: 3rem;
      text-align: center;
    }
    .person-card {
      border: 1px solid #ccc;
      padding: 1rem;
      margin-top: 1.2rem;
      border-radius: 8px;
    }
    .summary {
      margin-top: 0.8rem;
      font-weight: bold;
    }
    .unassigned {
      color: #d32f2f;
    }
    .done {
      color: #2e7d32;
    }
    #reset {
      width: 100%;
      margin-top: 1.5rem;
      padding: 1rem;
      font-size: 1.2rem;
      background: #f44336;
      color: #fff;
    }
    #sendOrder {
      width: 100%;
      margin-top: 1rem;
      padding: 1rem;
      font-size: 1.2rem;
      background: #4caf50;
      color: #fff;
    }
    .special-requests-container {
      margin-top: 2rem;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    textarea {
      width: 100%;
      min-height: 80px;
      padding: 5px;
      font-size: 1rem;
    }
  </style>
</head>
<body>

<h1>Bierzelt Rechner</h1>

<h2>1. Bestellung erfassen:</h2>
<div id="order-section"></div>

<div class="special-requests-container">
  <h2>Sonderw√ºnsche</h2>
  <textarea id="specialRequests" placeholder="Hier k√∂nnen Sie spezielle Anmerkungen oder W√ºnsche eingeben..."></textarea>
</div>

<h2>2. Personen zuordnen:</h2>
<div id="persons"></div>
<button id="addPersonBtn" onclick="addPerson()">‚ûï Person hinzuf√ºgen</button>

<h2>Noch ausstehend</h2>
<div id="remaining"></div>

<button id="sendOrder" onclick="sendOrderToFirebase()">‚úÖ Bestellung senden</button>
<button id="reset" onclick="resetAll()">Zur√ºcksetzen</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDz7S1YcdJ7Tm3F7YLUpT61esfDlIbAH08",
    authDomain: "bierzelt-rechner.firebaseapp.com",
    databaseURL: "https://bierzelt-rechner-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "bierzelt-rechner",
    storageBucket: "bierzelt-rechner.firebasestorage.app",
    messagingSenderId: "322991437255",
    appId: "1:322991437255:web:74a25783bf98433a0fd5e2"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const DRINKS = [
    { key: "mass_bier", name: "üç∫ Ma√ü Bier", price: 8.9 },
    { key: "halbe_bier", name: "üçª Halbe Bier", price: 4.8 },
    { key: "mass_radler", name: "üç∫üçã Ma√ü Radler", price: 8.9 },
    { key: "halbe_radler", name: "üçªüçã Halbe Radler", price: 4.8 },
    { key: "mass_bier_alkfrei", name: "üç∫ Ma√ü Bier Alkoholfrei", price: 8.9 },
    { key: "halbe_bier_alkfrei", name: "üçª Halbe Bier Alkoholfrei", price: 4.8 },
    { key: "mass_radler_alkfrei", name: "üç∫üçã Ma√ü Radler Alkoholfrei", price: 8.9 },
    { key: "halbe_radler_alkfrei", name: "üçªüçã Halbe Radler Alkoholfrei", price: 4.8 },
    { key: "weinschorle", name: "üç∑ Weinschorle", price: 4.6 },
    { key: "aperol", name: "üçä Aperol", price: 6.0 },
    { key: "apfelschorle", name: "üçé Apfelschorle", price: 3.2 },
    { key: "limo_gelb", name: "üçã Limo gelb", price: 3.2 },
    { key: "limo_weiss", name: "‚ö™Ô∏è Limo wei√ü", price: 3.2 },
    { key: "spezi", name: "ü•§ Spezi", price: 3.2 },
    { key: "wasser", name: "üíß Wasser", price: 3.2 }
  ];

  const order = {};
  DRINKS.forEach(d => order[d.key] = 0);
  let persons = [];

  addPerson(); // Initial

  function format(eur) {
    return eur.toFixed(2).replace('.', ',') + ' ‚Ç¨';
  }

  function renderOrder() {
    const el = document.getElementById('order-section');
    el.innerHTML = '';
    let totalOrderSum = 0;

    DRINKS.forEach(d => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <span class="name">${d.name} (${format(d.price)})</span>
        <button onclick="changeOrder('${d.key}', -1)">‚àí</button>
        <span class="count" id="order-${d.key}">${order[d.key]}</span>
        <button onclick="changeOrder('${d.key}', 1)">+</button>`;
      el.appendChild(div);
      totalOrderSum += order[d.key] * d.price;
    });

    el.innerHTML += `<div class="summary"><strong>Gesamtsumme Bestellung: ${format(totalOrderSum)}</strong></div>`;
    renderAll();
  }

  function changeOrder(key, delta) {
    order[key] = Math.max(0, order[key] + delta);
    document.getElementById('order-' + key).textContent = order[key];
    renderAll();
  }

  function addPerson() {
    const id = persons.length > 0 ? Math.max(...persons.map(p => p.id)) + 1 : 0;
    const person = { id, name: `Person ${id + 1}`, drinks: {} };
    DRINKS.forEach(d => person.drinks[d.key] = 0);
    persons.push(person);
    renderAll();
  }

  function changePersonDrink(personId, key, delta) {
    const p = persons.find(x => x.id === personId);
    if (!p) return;
    const totalOrdered = order[key];
    const assigned = persons.reduce((s, per) => s + per.drinks[key], 0);
    if (delta > 0 && assigned >= totalOrdered) return;
    p.drinks[key] = Math.max(0, p.drinks[key] + delta);
    renderAll();
  }

  function renderPersons() {
    const container = document.getElementById('persons');
    container.innerHTML = '';
    persons.forEach(p => {
      const card = document.createElement('div');
      card.className = 'person-card';
      card.innerHTML = `<strong>${p.name}</strong><br>`;
      let sum = 0;
      DRINKS.forEach(d => {
        const c = p.drinks[d.key];
        if (order[d.key] > 0 || c > 0) {
          sum += c * d.price;
          card.innerHTML += `
            <div class="drink-row">
              <span class="label">${d.name}</span>
              <button onclick="changePersonDrink(${p.id}, '${d.key}', -1)">‚àí</button>
              <span class="count">${c}</span>
              <button onclick="changePersonDrink(${p.id}, '${d.key}', 1)">+</button>
            </div>`;
        }
      });
      card.innerHTML += `<div class="summary">Summe: ${format(sum)}</div>`;
      container.appendChild(card);
    });
  }

  function renderRemaining() {
    const div = document.getElementById('remaining');
    div.innerHTML = '';
    DRINKS.forEach(d => {
      const total = order[d.key];
      const assigned = persons.reduce((s, p) => s + p.drinks[d.key], 0);
      const left = total - assigned;
      if (total > 0) {
        const cls = left === 0 ? 'done' : 'unassigned';
        div.innerHTML += `<div class="${cls}">${d.name}: ${left} ${left === 0 ? '‚úîÔ∏è' : 'ausstehend'}</div>`;
      }
    });
  }

  function renderAll() {
    renderPersons();
    renderRemaining();
  }

  function resetAll() {
    DRINKS.forEach(d => order[d.key] = 0);
    persons = [];
    addPerson();
    document.getElementById('specialRequests').value = '';
    renderOrder();
  }

  function sendOrderToFirebase() {
    const waitstaffName = prompt("Name der Bedienung:");
    if (!waitstaffName) return;

    const orderQuantities = { ...order };
    const specialRequests = document.getElementById('specialRequests').value;

    const newOrderRef = push(ref(db, 'bierzelt/orders'));
    set(newOrderRef, {
      waitstaffName,
      orderQuantities,
      specialRequests,
      timestamp: Date.now()
    }).then(() => {
      alert("Bestellung erfolgreich gesendet!");
      resetAll();
    }).catch(err => {
      alert("Fehler beim Senden: " + err.message);
    });
  }

  renderOrder();
</script>

</body>
</html>
